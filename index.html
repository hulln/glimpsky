<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluesky Profile Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 680px;
            margin: 0 auto;
        }

        .about-btn {
            padding: 3px 10px;
            background: white;
            color: #64748b;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            margin-left: auto;
            display: block;
            margin-bottom: 12px;
        }

        .about-btn:hover {
            background: #f8fafc;
            color: #0f172a;
            border-color: #cbd5e1;
        }

        .header {
            background: white;
            padding: 32px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }

        h1 {
            color: #0f172a;
            margin-bottom: 8px;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s;
        }

        h1:hover {
            color: #3b82f6;
        }

        .subtitle {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 28px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #475569;
            font-weight: 500;
            font-size: 13px;
        }

        input[type="text"] {
            width: 100%;
            padding: 11px 14px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.2s;
            background: white;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-options {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .advanced-filters-inline {
            margin-bottom: 20px;
        }

        .advanced-filters-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .advanced-filters-toggle:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .advanced-filters-toggle span:first-child {
            font-size: 13px;
            font-weight: 500;
            color: #475569;
        }

        .toggle-icon {
            font-size: 12px;
            color: #64748b;
            transition: transform 0.2s;
        }

        .advanced-filters-toggle.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .advanced-filters-content {
            display: none;
            padding: 16px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }

        .advanced-filters-content.expanded {
            display: block;
        }

        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }

        .filter-section label {
            font-size: 13px;
            color: #475569;
            font-weight: 500;
            margin: 0;
        }

        .date-inputs {
            display: flex;
            gap: 8px;
        }

        .date-inputs input[type="date"] {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .date-inputs input[type="date"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-input {
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            width: 100%;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .advanced-buttons {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .btn-outline {
            background: white;
            color: #475569;
            padding: 10px 18px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            flex: 0 0 auto;
        }

        .btn-outline:hover:not(:disabled) {
            background: #f8fafc;
            border-color: #94a3b8;
            color: #0f172a;
            transform: translateY(-1px);
        }

        .warning-text {
            background: #f1f5f9;
            color: #475569;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid #e2e8f0;
            margin-top: 8px;
            display: none;
        }

        .warning-text.show {
            display: flex;
        }

        .warning-text .btn-outline {
            padding: 6px 14px;
            font-size: 12px;
            margin: 0;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #3b82f6;
        }

        .checkbox-group label {
            margin: 0;
            font-size: 14px;
            color: #475569;
            font-weight: 400;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 11px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #0f172a;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1e293b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.15);
        }

        .btn-secondary {
            background: white;
            color: #0f172a;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .profile-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 24px;
            display: none;
        }

        .profile-header {
            display: flex;
            align-items: start;
            gap: 16px;
            margin-bottom: 20px;
        }

        .avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e2e8f0;
        }

        .profile-info h2 {
            color: #0f172a;
            margin-bottom: 4px;
            font-size: 20px;
            font-weight: 600;
        }

        .handle {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .description {
            color: #475569;
            line-height: 1.5;
            margin-top: 12px;
            font-size: 14px;
        }

        .stats {
            display: flex;
            gap: 24px;
            padding-top: 16px;
            border-top: 1px solid #f1f5f9;
            flex-wrap: wrap;
        }

        .stat {
            display: flex;
            gap: 6px;
            align-items: baseline;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #0f172a;
        }

        .stat-label {
            font-size: 14px;
            color: #64748b;
            font-weight: 400;
        }

        .statButton {
            background: transparent;
            border: 0;
            padding: 0;
            cursor: pointer;
            text-align: left;
            font-family: inherit;
        }

        .statButton:hover .stat-value {
            text-decoration: underline;
        }

        .statButton .stat-value,
        .statButton .stat-label {
            font-size: 16px;
            font-weight: 600;
        }

        .statButton .stat-label {
            font-weight: 400;
            font-size: 14px;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 9999;
        }

        .modal.open {
            display: flex;
        }

        .info-modal-content {
            width: min(500px, 90%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.25);
            overflow: hidden;
        }

        .info-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #f1f5f9;
        }

        .info-modal-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #0f172a;
        }

        .info-modal-body {
            padding: 20px 24px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .info-modal-body p {
            color: #475569;
            line-height: 1.6;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .info-modal-body p:last-child {
            margin-bottom: 0;
        }

        .info-modal-body a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
        }

        .info-modal-body a:hover {
            text-decoration: underline;
        }

        .info-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #f1f5f9;
            display: flex;
            justify-content: flex-end;
        }

        .info-modal-footer button {
            padding: 8px 16px;
            background: #0f172a;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .info-modal-footer button:hover {
            background: #1e293b;
        }

        .modal-content {
            width: min(720px, 100%);
            max-height: 85vh;
            background: white;
            border-radius: 16px;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.25);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid #f1f5f9;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: #0f172a;
            flex: 1;
        }

        .iconButton {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
            color: #64748b;
            padding: 0;
            width: auto;
            height: auto;
        }

        .iconButton:hover {
            color: #0f172a;
        }

        .modal-meta {
            padding: 10px 16px;
            font-size: 13px;
            color: #64748b;
            border-bottom: 1px solid #f1f5f9;
        }

        .modal-list {
            flex: 1;
            overflow: auto;
            padding: 10px 12px;
            background: #ffffff;
        }

        .list-item {
            display: flex;
            gap: 12px;
            padding: 10px 10px;
            border-radius: 12px;
            cursor: pointer;
        }

        .list-item:hover {
            background: #f8fafc;
        }

        .list-avatar {
            width: 40px;
            height: 40px;
            border-radius: 999px;
            object-fit: cover;
            border: 1px solid #e2e8f0;
            background: #f1f5f9;
            flex-shrink: 0;
        }

        .list-main {
            flex: 1;
            min-width: 0;
        }

        .list-name {
            font-weight: 600;
            color: #0f172a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .list-handle {
            font-size: 13px;
            color: #64748b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        .modal-footer {
            padding: 12px 16px;
            border-top: 1px solid #f1f5f9;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: #ffffff;
        }


        .content-section {
            display: none;
        }

        .section-header {
            background: white;
            padding: 16px 24px;
            border-radius: 8px 8px 0 0;
            border: 1px solid #e2e8f0;
            border-bottom: none;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #0f172a;
        }

        #content {
            background: white;
            border-left: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
        }

        .load-more-container {
            background: white;
            padding: 20px;
            border-radius: 0 0 8px 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .load-more {
            padding: 10px 24px;
            background: white;
            color: #0f172a;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .load-more:hover:not(:disabled) {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
        }

        .post {
            padding: 20px 24px;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.15s;
            cursor: pointer;
        }

        .post:hover {
            background: #f8fafc;
        }

        .post:last-child {
            border-bottom: none;
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .post-author {
            flex: 1;
            min-width: 0;
        }

        .post-name {
            font-weight: 600;
            color: #0f172a;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .post-handle {
            color: #64748b;
            font-size: 14px;
        }

        .post-time {
            color: #94a3b8;
            font-size: 13px;
            white-space: nowrap;
        }

        .post-text {
            color: #334155;
            line-height: 1.5;
            margin-bottom: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 15px;
        }

        .post-text a {
            color: #3b82f6;
            text-decoration: none;
        }

        .post-text a:hover {
            text-decoration: underline;
        }

        .post-image {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
        }

        .post-engagement {
            display: flex;
            gap: 16px;
            color: #64748b;
            font-size: 13px;
        }

        .engagement-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .repost-indicator {
            color: #64748b;
            font-size: 13px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .reply-indicator {
            color: #64748b;
            font-size: 13px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .spinner {
            border: 2px solid #f1f5f9;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fef2f2;
            color: #991b1b;
            padding: 14px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #fecaca;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state p {
            font-size: 14px;
        }

        .success-message {
            background: #f0fdf4;
            color: #166534;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid #bbf7d0;
            margin-bottom: 16px;
        }

        @media (max-width: 640px) {
            body {
                padding: 20px 16px;
            }

            .header {
                padding: 24px;
            }

            .info-banner {
                padding: 16px 20px;
            }

            .info-banner h2 {
                font-size: 16px;
            }

            .info-banner p {
                font-size: 12px;
            }

            .filter-options {
                flex-direction: column;
                gap: 12px;
            }

            .button-group {
                flex-direction: column;
            }

            .profile-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .stats {
                justify-content: center;
                flex-wrap: wrap;
                gap: 16px;
            }

            .post {
                padding: 16px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="about-btn" id="infoBtn" type="button">About</button>
        
        <div class="header">
            <h1 id="mainTitle">Bluesky Profile Viewer</h1>
            <p class="subtitle">View posts and likes from any Bluesky profile</p>
            
            <div class="input-group">
                <label for="handle">Bluesky Handle or DID</label>
                <input 
                    type="text" 
                    id="handle" 
                    placeholder="e.g., user.bsky.social or oblachek.eu"
                    value="">
            </div>

            <div class="filter-options">
                <div class="checkbox-group">
                    <input type="checkbox" id="hideReposts" checked>
                    <label for="hideReposts">Hide reposts</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="hideReplies">
                    <label for="hideReplies">Hide replies</label>
                </div>
            </div>

            <div class="advanced-filters-inline" id="advancedFiltersInline">
                <div class="advanced-filters-toggle" id="advancedFiltersToggle">
                    <span>Advanced filters</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="advanced-filters-content" id="advancedFiltersContent">
                    <div class="filter-section">
                        <label for="dateFrom">Filter by date range</label>
                        <div class="date-inputs">
                            <input type="date" id="dateFrom" placeholder="From">
                            <input type="date" id="dateTo" placeholder="To">
                        </div>
                    </div>

                    <div class="filter-section" style="margin-top: 12px;">
                        <label for="searchText">Search posts by text</label>
                        <input type="text" class="search-input" id="searchText" placeholder="Enter keywords...">
                    </div>

                    <div class="advanced-buttons">
                        <button class="btn-primary" id="applyFiltersBtn" style="display: none;">Apply Filters</button>
                    </div>
                    <div class="warning-text show" style="margin-top: 12px; display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                        <span style="flex: 1;">Filtering requires loading all content first. Use "Load All" for faster filtering.</span>
                        <button class="btn-outline" id="loadAllBtn" style="flex-shrink: 0;">Load All</button>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-primary" id="loadPostsBtn">View Posts</button>
                <button class="btn-secondary" id="loadLikesBtn">View Likes</button>
            </div>
        </div>

        <div id="error"></div>
        
        <div class="profile-card" id="profileCard"></div>

        <div class="content-section" id="contentSection">
            <div class="section-header">
                <h3 class="section-title" id="sectionTitle">Posts</h3>
            </div>
            <div id="content"></div>
            <div class="load-more-container" id="loadMoreContainer" style="display: none;">
                <button class="load-more" id="loadMoreBtn">Load More</button>
            </div>
        </div>
    </div>

    
    <div id="listModal" class="modal" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="listModalTitle">
            <div class="modal-header">
                <div class="modal-title" id="listModalTitle">List</div>
                <button id="listModalClose" class="iconButton" type="button" aria-label="Close">×</button>
            </div>
            <div id="listModalMeta" class="modal-meta"></div>
            <div id="listModalList" class="modal-list"></div>
            <div class="modal-footer">
                <button id="listModalLoadMore" class="btn-secondary" type="button">Load more</button>
            </div>
        </div>
    </div>

    <div id="infoModal" class="modal" aria-hidden="true">
        <div class="info-modal-content" role="dialog" aria-modal="true">
            <div class="info-modal-header">
                <h2>About This Tool</h2>
            </div>
            <div class="info-modal-body">
                <p>This Bluesky Profile Viewer allows you to explore public posts, likes, followers, and other information from any Bluesky account. All data is retrieved from publicly available Bluesky APIs and PDS (Personal Data Server) endpoints.</p>
                
                <p><strong>Inspirations:</strong></p>
                <p>• <a href="https://github.com/ClearskyApp06/clearskyservices" target="_blank" rel="noopener noreferrer">Clearsky</a> - for blocking analytics and advanced features<br>
                • <a href="https://github.com/luizzeroxis/bluesky-likes/" target="_blank" rel="noopener noreferrer">Bluesky Likes by luizzeroxis</a> - for viewing likes of others</p>
                
                <p><strong>Made by:</strong> <a href="https://bsky.app/profile/oblachek.eu" target="_blank" rel="noopener noreferrer">oblachek.eu</a> with big help from ChatGPT and Claude.</p>
                
                <p>This tool is for informational and educational purposes only.</p>
            </div>
            <div class="info-modal-footer">
                <button id="infoModalClose" type="button">Close</button>
            </div>
        </div>
    </div>

<script>
        const API_PUBLIC = 'https://public.api.bsky.app/xrpc';
        
        let currentHandle = '';
        let currentDid = '';
        let currentPdsUrl = '';
        let currentProfile = null;
        let currentCursor = null;
        let currentMode = 'posts';
        let isLoading = false;
        let allPosts = [];
        let allPostsLoaded = false;

        const elements = {
            handleInput: document.getElementById('handle'),
            loadPostsBtn: document.getElementById('loadPostsBtn'),
            loadLikesBtn: document.getElementById('loadLikesBtn'),
            loadMoreBtn: document.getElementById('loadMoreBtn'),
            loadMoreContainer: document.getElementById('loadMoreContainer'),
            hideReposts: document.getElementById('hideReposts'),
            hideReplies: document.getElementById('hideReplies'),
            profileCard: document.getElementById('profileCard'),
            contentSection: document.getElementById('contentSection'),
            content: document.getElementById('content'),
            error: document.getElementById('error'),
            sectionTitle: document.getElementById('sectionTitle'),
            listModal: document.getElementById('listModal'),
            listModalTitle: document.getElementById('listModalTitle'),
            listModalMeta: document.getElementById('listModalMeta'),
            listModalList: document.getElementById('listModalList'),
            listModalClose: document.getElementById('listModalClose'),
            listModalLoadMore: document.getElementById('listModalLoadMore'),
            infoModal: document.getElementById('infoModal'),
            infoBtn: document.getElementById('infoBtn'),
            infoModalClose: document.getElementById('infoModalClose'),
            mainTitle: document.getElementById('mainTitle'),
            dateFrom: document.getElementById('dateFrom'),
            dateTo: document.getElementById('dateTo'),
            searchText: document.getElementById('searchText'),
            loadAllBtn: document.getElementById('loadAllBtn'),
            applyFiltersBtn: document.getElementById('applyFiltersBtn'),
            advancedFiltersToggle: document.getElementById('advancedFiltersToggle'),
            advancedFiltersContent: document.getElementById('advancedFiltersContent')
        };

        elements.loadPostsBtn.addEventListener('click', () => loadContent('posts'));
        elements.loadLikesBtn.addEventListener('click', () => loadContent('likes'));
        elements.loadMoreBtn.addEventListener('click', loadMore);
        elements.handleInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadContent('posts');
        });

        elements.loadAllBtn.addEventListener('click', loadAllPosts);
        
        elements.searchText.addEventListener('input', () => {
            if (elements.searchText.value.trim()) {
                elements.applyFiltersBtn.style.display = 'block';
            } else if (!elements.dateFrom.value && !elements.dateTo.value) {
                elements.applyFiltersBtn.style.display = 'none';
            }
        });

        elements.dateFrom.addEventListener('change', () => {
            if (elements.dateFrom.value || elements.dateTo.value) {
                elements.applyFiltersBtn.style.display = 'block';
            } else if (!elements.searchText.value.trim()) {
                elements.applyFiltersBtn.style.display = 'none';
            }
        });

        elements.dateTo.addEventListener('change', () => {
            if (elements.dateFrom.value || elements.dateTo.value) {
                elements.applyFiltersBtn.style.display = 'block';
            } else if (!elements.searchText.value.trim()) {
                elements.applyFiltersBtn.style.display = 'none';
            }
        });

        elements.applyFiltersBtn.addEventListener('click', applyFilters);

        elements.advancedFiltersToggle.addEventListener('click', () => {
            elements.advancedFiltersToggle.classList.toggle('expanded');
            elements.advancedFiltersContent.classList.toggle('expanded');
        });

        elements.infoBtn.addEventListener('click', () => {
            elements.infoModal.classList.add('open');
            elements.infoModal.setAttribute('aria-hidden', 'false');
        });

        elements.infoModalClose.addEventListener('click', () => {
            elements.infoModal.classList.remove('open');
            elements.infoModal.setAttribute('aria-hidden', 'true');
        });

        elements.infoModal.addEventListener('click', (e) => {
            if (e.target === elements.infoModal) {
                elements.infoModal.classList.remove('open');
                elements.infoModal.setAttribute('aria-hidden', 'true');
            }
        });

        elements.mainTitle.addEventListener('click', () => {
            elements.handleInput.value = '';
            elements.profileCard.style.display = 'none';
            elements.contentSection.style.display = 'none';
            elements.content.innerHTML = '';
            elements.error.innerHTML = '';
            currentHandle = '';
            currentDid = '';
            currentPdsUrl = '';
            currentProfile = null;
            currentCursor = null;
            currentMode = 'posts';
            allPosts = [];
            allPostsLoaded = false;
            elements.hideReposts.checked = true;
            elements.hideReplies.checked = false;
            elements.dateFrom.value = '';
            elements.dateTo.value = '';
            elements.searchText.value = '';
            elements.applyFiltersBtn.style.display = 'none';
            elements.advancedFiltersContent.classList.remove('expanded');
            elements.advancedFiltersToggle.classList.remove('expanded');
        });

        function showError(message) {
            elements.error.innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
            setTimeout(() => {
                elements.error.innerHTML = '';
            }, 8000);
        }

        function showLoading() {
            elements.content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading...</p>
                </div>
            `;
        }

        function setLoading(loading) {
            isLoading = loading;
            elements.loadPostsBtn.disabled = loading;
            elements.loadLikesBtn.disabled = loading;
            elements.loadMoreBtn.disabled = loading;
        }

        async function resolveHandle(handle) {
            try {
                handle = handle.trim()
                    .replace('https://', '')
                    .replace('http://', '')
                    .replace('bsky.app/profile/', '')
                    .replace('@', '');

                if (handle.startsWith('did:')) {
                    return handle;
                }

                const response = await fetch(
                    `${API_PUBLIC}/com.atproto.identity.resolveHandle?handle=${encodeURIComponent(handle)}`
                );
                
                if (!response.ok) {
                    throw new Error('Could not resolve handle. Please check if it exists.');
                }
                
                const data = await response.json();
                return data.did;
            } catch (error) {
                throw new Error(`Failed to resolve handle: ${error.message}`);
            }
        }

        async function getPdsUrl(did) {
            try {
                const response = await fetch(`https://plc.directory/${did}`);
                if (!response.ok) {
                    throw new Error('Could not fetch DID document');
                }
                
                const didDoc = await response.json();
                
                const pdsService = didDoc.service?.find(s => s.id === '#atproto_pds');
                if (!pdsService) {
                    throw new Error('No PDS service found in DID document');
                }
                
                return pdsService.serviceEndpoint;
            } catch (error) {
                throw new Error(`Failed to get PDS URL: ${error.message}`);
            }
        }

        async function loadProfile(did) {
            try {
                const response = await fetch(
                    `${API_PUBLIC}/app.bsky.actor.getProfile?actor=${encodeURIComponent(did)}`
                );

                if (!response.ok) {
                    throw new Error('Could not load profile');
                }

                const profile = await response.json();
                currentProfile = profile;
                displayProfile(profile);
                return profile;
            } catch (error) {
                throw new Error(`Failed to load profile: ${error.message}`);
            }
        }

        function displayProfile(profile) {
            const avatar = profile.avatar || 'https://via.placeholder.com/80';
            const displayName = profile.displayName || profile.handle;
            const description = profile.description || '';

            elements.profileCard.innerHTML = `
                <div class="profile-header">
                    <img src="${avatar}" alt="${escapeHtml(displayName)}" class="avatar">
                    <div class="profile-info">
                        <h2>${escapeHtml(displayName)}</h2>
                        <div class="handle">@${escapeHtml(profile.handle)}</div>
                        ${description ? `<div class="description">${escapeHtml(description)}</div>` : ''}
                    </div>
                </div>

                <div class="stats">
                    <div class="stat">
                        <span class="stat-value">${formatNumber(profile.postsCount || 0)}</span>
                        <span class="stat-label">posts</span>
                    </div>
                    <button class="stat statButton" id="followersStat" type="button" title="Show followers">
                        <span class="stat-value">${formatNumber(profile.followersCount || 0)}</span>
                        <span class="stat-label">followers</span>
                    </button>
                    <button class="stat statButton" id="followingStat" type="button" title="Show following">
                        <span class="stat-value">${formatNumber(profile.followsCount || 0)}</span>
                        <span class="stat-label">following</span>
                    </button>
                    <button class="stat statButton" id="mutualsStat" type="button" title="Compute mutuals (can take a while on big accounts)">
                        <span class="stat-value" id="mutualsCount">—</span>
                        <span class="stat-label">mutuals</span>
                    </button>
                    <button class="stat statButton" id="blockingStat" type="button" title="Show accounts this user blocks">
                        <span class="stat-value" id="blockingCount">—</span>
                        <span class="stat-label">blocking</span>
                    </button>
                    <button class="stat statButton" id="blockedByStat" type="button" title="Show accounts that block this user">
                        <span class="stat-value" id="blockedByCount">—</span>
                        <span class="stat-label">blocked by</span>
                    </button>
                </div>
            `;
            elements.profileCard.style.display = 'block';

            wireProfileStatsButtons();
        }

        let listCursor = null;
        let listLoader = null;
        let listLoading = false;
        let listNote = '';

        function openListModal(title, note, loader) {
            listCursor = null;
            listLoader = loader;
            listLoading = false;
            listNote = note || '';
            elements.listModalTitle.textContent = title;
            elements.listModalMeta.textContent = listNote;
            elements.listModalList.innerHTML = '';
            elements.listModalLoadMore.style.display = 'none';
            elements.listModal.classList.add('open');
            elements.listModal.setAttribute('aria-hidden', 'false');
            loadMoreList();
        }

        function closeListModal() {
            elements.listModal.classList.remove('open');
            elements.listModal.setAttribute('aria-hidden', 'true');
            elements.listModalList.innerHTML = '';
            elements.listModalMeta.textContent = '';
            listCursor = null;
            listLoader = null;
            listLoading = false;
            listNote = '';
        }

        async function loadMoreList() {
            if (!listLoader || listLoading) return;
            listLoading = true;
            elements.listModalLoadMore.disabled = true;
            elements.listModalLoadMore.textContent = 'Loading…';
            try {
                const res = await listLoader(listCursor);
                const profiles = res?.profiles || [];
                renderProfileListItems(profiles);
                listCursor = res?.cursor || null;
                elements.listModalLoadMore.style.display = listCursor ? 'inline-flex' : 'none';
            } catch (e) {
                const msg = (e && e.message) ? e.message : String(e);
                elements.listModalList.insertAdjacentHTML('beforeend', `
                    <div class="empty-state" style="padding: 16px 10px;">
                        <p>Failed to load list</p>
                        <p style="font-size: 13px; margin-top: 8px; color: #94a3b8;">${escapeHtml(msg)}</p>
                    </div>
                `);
                elements.listModalLoadMore.style.display = 'none';
            } finally {
                listLoading = false;
                elements.listModalLoadMore.disabled = false;
                elements.listModalLoadMore.textContent = 'Load more';
            }
        }

        function renderProfileListItems(profiles) {
            if (!profiles || profiles.length === 0) {
                if (!elements.listModalList.children.length) {
                    elements.listModalList.innerHTML = `
                        <div class="empty-state" style="padding: 16px 10px;">
                            <p>Nothing here</p>
                        </div>
                    `;
                }
                return;
            }

            const html = profiles.map(p => {
                const avatar = p.avatar || 'https://via.placeholder.com/40';
                const name = p.displayName || p.handle || p.did || '';
                const handle = p.handle ? '@' + p.handle : (p.did || '');
                const actor = p.handle || p.did || '';
                return `
                    <div class="list-item" data-actor="${escapeHtml(actor)}">
                        <img class="list-avatar" src="${escapeHtml(avatar)}" alt="">
                        <div class="list-main">
                            <div class="list-name">${escapeHtml(name)}</div>
                            <div class="list-handle">${escapeHtml(handle)}</div>
                        </div>
                    </div>
                `;
            }).join('');

            elements.listModalList.insertAdjacentHTML('beforeend', html);

            [...elements.listModalList.querySelectorAll('.list-item')].slice(-profiles.length).forEach(el => {
                el.addEventListener('click', async () => {
                    const actor = el.getAttribute('data-actor');
                    closeListModal();
                    if (actor) {
                        elements.handleInput.value = actor;
                        await loadContent(currentMode);
                    }
                });
            });
        }

        function makeStaticPager(items, pageSize = 50) {
            return async (cursor) => {
                const offset = cursor ? parseInt(cursor, 10) : 0;
                const slice = items.slice(offset, offset + pageSize);
                const next = (offset + pageSize) < items.length ? String(offset + pageSize) : null;
                return { profiles: slice, cursor: next };
            };
        }

        async function bskyGetProfiles(actors) {
            if (!actors || actors.length === 0) return { profiles: [] };
            const chunks = [];
            for (let i = 0; i < actors.length; i += 25) {
                chunks.push(actors.slice(i, i + 25));
            }
            const out = [];
            for (const chunk of chunks) {
                const params = chunk.map(a => `actors=${encodeURIComponent(a)}`).join('&');
                const url = `${API_PUBLIC}/app.bsky.actor.getProfiles?${params}`;
                const res = await fetch(url);
                if (res.ok) {
                    const data = await res.json();
                    out.push(...(data.profiles || []));
                }
            }
            return { profiles: out };
        }

        async function bskyGetFollowersPage(cursor = null, limit = 50) {
            let url = `${API_PUBLIC}/app.bsky.graph.getFollowers?actor=${encodeURIComponent(currentDid)}&limit=${limit}`;
            if (cursor) url += `&cursor=${encodeURIComponent(cursor)}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Failed to load followers');
            const data = await res.json();
            return { profiles: data.followers || [], cursor: data.cursor || null };
        }

        async function bskyGetFollowsPage(cursor = null, limit = 50) {
            let url = `${API_PUBLIC}/app.bsky.graph.getFollows?actor=${encodeURIComponent(currentDid)}&limit=${limit}`;
            if (cursor) url += `&cursor=${encodeURIComponent(cursor)}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Failed to load following');
            const data = await res.json();
            return { profiles: data.follows || [], cursor: data.cursor || null };
        }

        async function pdsListRecords(collection, cursor = null, limit = 50) {
            let url = `${currentPdsUrl}/xrpc/com.atproto.repo.listRecords?repo=${encodeURIComponent(currentDid)}&collection=${encodeURIComponent(collection)}&limit=${limit}`;
            if (cursor) url += `&cursor=${encodeURIComponent(cursor)}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Failed to list records from PDS');
            return await res.json();
        }

        async function getBlockingPage(cursor = null) {
            const data = await pdsListRecords('app.bsky.graph.block', cursor, 50);
            const dids = (data.records || [])
                .map(r => (r && r.value) ? (r.value.subject?.did || r.value.subject) : null)
                .filter(Boolean);

            const profilesRes = await bskyGetProfiles(dids);
            const profiles = profilesRes.profiles || [];

            return { profiles, cursor: data.cursor || null };
        }

        async function computeMutuals(maxFetch = 5000) {
            const followers = [];
            const follows = [];
            let followerCursor = null;
            let followCursor = null;

            while (followers.length < maxFetch) {
                const page = await bskyGetFollowersPage(followerCursor, Math.min(100, maxFetch - followers.length));
                followers.push(...(page.profiles || []));
                followerCursor = page.cursor;
                if (!followerCursor) break;
            }

            while (follows.length < maxFetch) {
                const page = await bskyGetFollowsPage(followCursor, Math.min(100, maxFetch - follows.length));
                follows.push(...(page.profiles || []));
                followCursor = page.cursor;
                if (!followCursor) break;
            }

            const followerSet = new Set(followers.map(p => p.did));
            const mutuals = follows.filter(p => followerSet.has(p.did));

            const truncated = Boolean(followerCursor || followCursor);
            return { mutuals, truncated };
        }

        function openBlockedByInfo() {
            openListModal(
                'Blocked by',
                'This feature is not currently available',
                makeStaticPager([])
            );
            elements.listModalLoadMore.style.display = 'none';
            elements.listModalList.innerHTML = `
                <div class="empty-state" style="padding: 16px 10px;">
                    <p>Feature unavailable</p>
                    <p style="font-size: 13px; margin-top: 8px; color: #94a3b8;">
                        This would require an external indexer service to determine which accounts have blocked this user.
                    </p>
                </div>
            `;
        }

        function wireProfileStatsButtons() {
            const followersEl = document.getElementById('followersStat');
            const followingEl = document.getElementById('followingStat');
            const mutualsEl = document.getElementById('mutualsStat');
            const blockingEl = document.getElementById('blockingStat');
            const blockedByEl = document.getElementById('blockedByStat');

            if (followersEl) {
                followersEl.onclick = () => openListModal('Followers', '', (cursor) => bskyGetFollowersPage(cursor, 50));
            }
            if (followingEl) {
                followingEl.onclick = () => openListModal('Following', '', (cursor) => bskyGetFollowsPage(cursor, 50));
            }
            if (mutualsEl) {
                mutualsEl.onclick = async () => {
                    openListModal('Mutuals', 'Computing…', makeStaticPager([]));
                    elements.listModalLoadMore.style.display = 'none';
                    elements.listModalList.innerHTML = `
                        <div class="loading" style="padding: 24px 10px;">
                            <div class="spinner"></div>
                            <p>Computing mutuals…</p>
                        </div>
                    `;
                    try {
                        const { mutuals, truncated } = await computeMutuals(5000);
                        const countEl = document.getElementById('mutualsCount');
                        if (countEl) countEl.textContent = formatNumber(mutuals.length);
                        openListModal(
                            `Mutuals (${mutuals.length}${truncated ? '+' : ''})`,
                            truncated ? 'Partial result (hit the 5000-per-list cap). Increase the cap in computeMutuals() if you need the full set.' : '',
                            makeStaticPager(mutuals, 50)
                        );
                    } catch (e) {
                        closeListModal();
                        showError(e.message || String(e));
                    }
                };
            }
            if (blockingEl) {
                blockingEl.onclick = async () => {
                    openListModal('Blocking', '', (cursor) => getBlockingPage(cursor));
                };
            }
            if (blockedByEl) {
                blockedByEl.onclick = () => openBlockedByInfo();
            }
        }

        elements.listModalClose.addEventListener('click', closeListModal);
        elements.listModalLoadMore.addEventListener('click', loadMoreList);
        elements.listModal.addEventListener('click', (e) => {
            if (e.target === elements.listModal) closeListModal();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (elements.listModal.classList.contains('open')) {
                    closeListModal();
                } else if (elements.infoModal.classList.contains('open')) {
                    elements.infoModal.classList.remove('open');
                    elements.infoModal.setAttribute('aria-hidden', 'true');
                }
            }
        });

        async function loadAllPosts() {
            if (!currentDid) {
                showError('Please load content first before using this feature');
                return;
            }

            if (allPostsLoaded) {
                showError('All content is already loaded');
                return;
            }

            const contentType = currentMode === 'posts' ? 'posts' : 'likes';
            const confirmed = confirm(`This will load all ${contentType} from this account. For accounts with many ${contentType}, this may take several minutes. Continue?`);
            if (!confirmed) return;

            setLoading(true);
            const statusDiv = document.createElement('div');
            statusDiv.className = 'warning-text show';
            statusDiv.style.marginBottom = '16px';
            statusDiv.textContent = `Loading all ${contentType}...`;
            elements.content.insertBefore(statusDiv, elements.content.firstChild);

            try {
                if (currentMode === 'posts') {
                    await loadAllPostsContent(statusDiv);
                } else {
                    await loadAllLikesContent(statusDiv);
                }

                allPostsLoaded = true;
                currentCursor = null;
                elements.loadMoreContainer.style.display = 'none';
                
                statusDiv.className = 'success-message';
                statusDiv.textContent = `Successfully loaded all ${allPosts.length} ${contentType}`;
                
                setTimeout(() => {
                    statusDiv.remove();
                }, 5000);

            } catch (error) {
                showError(`Failed to load all ${contentType}: ` + error.message);
                statusDiv.remove();
            } finally {
                setLoading(false);
            }
        }

        async function loadAllPostsContent(statusDiv) {
            const hideReplies = elements.hideReplies.checked;
            let filter = hideReplies ? 'posts_no_replies' : 'posts_with_replies';
            let cursor = currentCursor;
            let batchCount = 0;

            while (cursor) {
                batchCount++;
                let url = `${API_PUBLIC}/app.bsky.feed.getAuthorFeed?actor=${encodeURIComponent(currentDid)}&filter=${filter}&limit=100`;
                url += `&cursor=${encodeURIComponent(cursor)}`;

                const response = await fetch(url);
                if (!response.ok) break;

                const data = await response.json();
                
                allPosts.push(...data.feed);
                
                displayPosts(data.feed, true);
                
                cursor = data.cursor || null;
                
                statusDiv.textContent = `Loading... ${allPosts.length} posts loaded (batch ${batchCount})`;
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        async function loadAllLikesContent(statusDiv) {
            let cursor = currentCursor;
            let batchCount = 0;
            let allLikeRecords = [];

            while (cursor) {
                batchCount++;
                let url = `${currentPdsUrl}/xrpc/com.atproto.repo.listRecords?repo=${encodeURIComponent(currentDid)}&collection=app.bsky.feed.like&limit=100`;
                url += `&cursor=${encodeURIComponent(cursor)}`;

                const response = await fetch(url);
                if (!response.ok) break;

                const data = await response.json();
                
                if (!data.records || data.records.length === 0) break;

                allLikeRecords.push(...data.records);
                
                const postUris = data.records.map(record => record.value.subject.uri);
                const posts = await fetchPosts(postUris);
                
                // Store posts with metadata for filtering
                const postsWithMeta = posts.map(post => ({
                    post: post,
                    reason: null,
                    reply: null,
                    likeTimestamp: data.records.find(r => r.value.subject.uri === post.uri)?.value.createdAt
                }));
                
                allPosts.push(...postsWithMeta);
                
                displayLikePosts(posts, data.records, true);
                
                cursor = data.cursor || null;
                
                statusDiv.textContent = `Loading... ${allLikeRecords.length} likes loaded (batch ${batchCount})`;
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        async function applyFilters() {
            const hasDateFilter = elements.dateFrom.value || elements.dateTo.value;
            const hasTextFilter = elements.searchText.value.trim();
            
            if (!hasDateFilter && !hasTextFilter) {
                showError('Please set at least one filter (date range or text search)');
                return;
            }

            if (!allPostsLoaded) {
                const confirmed = confirm('Filtering requires loading all content first. This may take a while for large accounts. Continue?');
                if (!confirmed) return;
                await loadAllPosts();
                if (!allPostsLoaded) return;
            }

            let filtered = [...allPosts];
            
            if (hasDateFilter) {
                const dateFrom = elements.dateFrom.value ? new Date(elements.dateFrom.value + 'T00:00:00') : null;
                const dateTo = elements.dateTo.value ? new Date(elements.dateTo.value + 'T23:59:59') : null;

                filtered = filtered.filter(item => {
                    const post = item.post;
                    let postDate;
                    
                    if (currentMode === 'likes' && item.likeTimestamp) {
                        // For likes, use the like timestamp
                        postDate = new Date(item.likeTimestamp);
                    } else {
                        // For posts, use the creation date
                        postDate = new Date(post.record.createdAt);
                    }
                    
                    if (dateFrom && postDate < dateFrom) return false;
                    if (dateTo && postDate > dateTo) return false;
                    return true;
                });
            }

            if (hasTextFilter) {
                const searchTerm = hasTextFilter.toLowerCase();
                filtered = filtered.filter(item => {
                    const post = item.post;
                    const text = (post.record.text || '').toLowerCase();
                    return text.includes(searchTerm);
                });
            }

            elements.content.innerHTML = '';
            if (filtered.length === 0) {
                const contentType = currentMode === 'posts' ? 'posts' : 'likes';
                elements.content.innerHTML = `
                    <div class="empty-state">
                        <p>No ${contentType} match your filters</p>
                        <p style="font-size: 13px; margin-top: 8px; color: #94a3b8;">
                            ${hasDateFilter ? 'Date range: ' + (elements.dateFrom.value || 'any') + ' to ' + (elements.dateTo.value || 'any') : ''}
                            ${hasTextFilter ? (hasDateFilter ? '<br>' : '') + 'Search: "' + escapeHtml(hasTextFilter) + '"' : ''}
                        </p>
                    </div>
                `;
            } else {
                if (currentMode === 'posts') {
                    displayPosts(filtered, false);
                } else {
                    // For likes, we need to extract just the posts
                    const posts = filtered.map(item => item.post);
                    const likeRecords = filtered.map(item => ({
                        value: {
                            subject: { uri: item.post.uri },
                            createdAt: item.likeTimestamp
                        }
                    }));
                    displayLikePosts(posts, likeRecords, false);
                }
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'success-message';
                infoDiv.textContent = `Showing ${filtered.length} of ${allPosts.length} ${currentMode}`;
                elements.content.insertBefore(infoDiv, elements.content.firstChild);
            }
        }

        async function loadContent(mode) {
            const handle = elements.handleInput.value.trim();
            
            if (!handle) {
                showError('Please enter a Bluesky handle or DID');
                return;
            }

            setLoading(true);
            elements.error.innerHTML = '';
            showLoading();
            
            try {
                currentDid = await resolveHandle(handle);
                currentPdsUrl = await getPdsUrl(currentDid);
                currentHandle = handle;
                currentMode = mode;
                currentCursor = null;
                allPosts = [];
                allPostsLoaded = false;

                await loadProfile(currentDid);

                if (mode === 'posts') {
                    elements.sectionTitle.textContent = 'Posts';
                    await loadPosts();
                } else {
                    elements.sectionTitle.textContent = 'Likes';
                    await loadLikes();
                }

                elements.contentSection.style.display = 'block';
            } catch (error) {
                showError(error.message);
                elements.profileCard.style.display = 'none';
                elements.contentSection.style.display = 'none';
            } finally {
                setLoading(false);
            }
        }

        async function loadPosts(append = false) {
            try {
                const hideReplies = elements.hideReplies.checked;
                let filter = hideReplies ? 'posts_no_replies' : 'posts_with_replies';
                
                let url = `${API_PUBLIC}/app.bsky.feed.getAuthorFeed?actor=${encodeURIComponent(currentDid)}&filter=${filter}&limit=50`;
                
                if (currentCursor) {
                    url += `&cursor=${encodeURIComponent(currentCursor)}`;
                }

                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Failed to load posts');
                }
                
                const data = await response.json();
                
                if (!append) {
                    allPosts = [...data.feed];
                } else {
                    allPosts.push(...data.feed);
                }
                
                displayPosts(data.feed, append);
                
                currentCursor = data.cursor || null;
                elements.loadMoreContainer.style.display = currentCursor ? 'block' : 'none';
            } catch (error) {
                showError(error.message);
            }
        }

        async function loadLikes(append = false) {
            try {
                let url = `${currentPdsUrl}/xrpc/com.atproto.repo.listRecords?repo=${encodeURIComponent(currentDid)}&collection=app.bsky.feed.like&limit=50`;
                
                if (currentCursor) {
                    url += `&cursor=${encodeURIComponent(currentCursor)}`;
                }

                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Failed to load likes from PDS');
                }
                
                const data = await response.json();
                
                if (!data.records || data.records.length === 0) {
                    if (!append) {
                        elements.content.innerHTML = `
                            <div class="empty-state">
                                <p>No likes found</p>
                            </div>
                        `;
                    }
                    elements.loadMoreContainer.style.display = 'none';
                    return;
                }

                const postUris = data.records.map(record => record.value.subject.uri);
                
                const posts = await fetchPosts(postUris);
                
                displayLikePosts(posts, data.records, append);
                
                currentCursor = data.cursor || null;
                elements.loadMoreContainer.style.display = currentCursor ? 'block' : 'none';
            } catch (error) {
                showError(error.message);
                if (!append) {
                    elements.content.innerHTML = `
                        <div class="empty-state">
                            <p>Failed to load likes</p>
                            <p style="font-size: 13px; margin-top: 8px; color: #94a3b8;">${escapeHtml(error.message)}</p>
                        </div>
                    `;
                }
            }
        }

        async function fetchPosts(uris) {
            if (uris.length === 0) return [];
            
            try {
                const chunks = [];
                for (let i = 0; i < uris.length; i += 25) {
                    chunks.push(uris.slice(i, i + 25));
                }
                
                const allPosts = [];
                for (const chunk of chunks) {
                    const urisParam = chunk.map(uri => `uris=${encodeURIComponent(uri)}`).join('&');
                    const url = `${API_PUBLIC}/app.bsky.feed.getPosts?${urisParam}`;
                    
                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        allPosts.push(...(data.posts || []));
                    }
                }
                
                return allPosts;
            } catch (error) {
                console.error('Error fetching posts:', error);
                return [];
            }
        }

        function displayLikePosts(posts, likeRecords, append = false) {
            if (!append) {
                elements.content.innerHTML = '';
            }

            if (posts.length === 0 && !append) {
                elements.content.innerHTML = `
                    <div class="empty-state">
                        <p>No likes found</p>
                    </div>
                `;
                return;
            }

            const likeTimestamps = {};
            likeRecords.forEach(record => {
                likeTimestamps[record.value.subject.uri] = new Date(record.value.createdAt);
            });

            posts.sort((a, b) => {
                const timeA = likeTimestamps[a.uri] || new Date(0);
                const timeB = likeTimestamps[b.uri] || new Date(0);
                return timeB - timeA;
            });

            posts.forEach(post => {
                const postDiv = createPostElement(post, null);
                elements.content.appendChild(postDiv);
            });
        }

        function displayPosts(feed, append = false) {
            const hideReposts = elements.hideReposts.checked;
            
            let filteredFeed = feed;
            if (hideReposts) {
                filteredFeed = feed.filter(item => {
                    return !item.reason || item.reason.$type !== 'app.bsky.feed.defs#reasonRepost';
                });
            }

            if (!append) {
                elements.content.innerHTML = '';
            }

            if (filteredFeed.length === 0 && !append) {
                elements.content.innerHTML = `
                    <div class="empty-state">
                        <p>No ${currentMode} found</p>
                    </div>
                `;
                return;
            }

            filteredFeed.forEach(item => {
                const post = item.post;
                const postDiv = createPostElement(post, item.reason, item.reply);
                elements.content.appendChild(postDiv);
            });
        }

        function createPostElement(post, reason, reply) {
            const div = document.createElement('div');
            div.className = 'post';
            
            const author = post.author;
            const record = post.record;
            const avatar = author.avatar || 'https://via.placeholder.com/40';
            
            const timestamp = new Date(record.createdAt);
            const timeAgo = getTimeAgo(timestamp);
            
            let postText = escapeHtml(record.text || '');
            
            if (record.facets && record.facets.length > 0) {
                postText = applyFacets(record.text, record.facets);
            }

            let html = '';
            
            if (reason && reason.$type === 'app.bsky.feed.defs#reasonRepost') {
                html += `<div class="repost-indicator">Reposted by @${escapeHtml(reason.by.handle)}</div>`;
            }
            
            if (reply && reply.parent) {
                const parentAuthor = reply.parent.author;
                if (parentAuthor && parentAuthor.handle) {
                    html += `<div class="reply-indicator">Reply to @${escapeHtml(parentAuthor.handle)}</div>`;
                }
            }

            html += `
                <div class="post-header">
                    <img src="${avatar}" alt="${escapeHtml(author.displayName || author.handle)}" class="post-avatar">
                    <div class="post-author">
                        <div class="post-name">${escapeHtml(author.displayName || author.handle)}</div>
                        <div class="post-handle">@${escapeHtml(author.handle)}</div>
                    </div>
                    <div class="post-time">${timeAgo}</div>
                </div>
                <div class="post-text">${postText}</div>
            `;

            if (post.embed && post.embed.$type === 'app.bsky.embed.images#view') {
                const images = post.embed.images || [];
                images.forEach(img => {
                    html += `<img src="${img.thumb}" alt="${escapeHtml(img.alt || '')}" class="post-image">`;
                });
            }

            html += `
                <div class="post-engagement">
                    <span class="engagement-item">${formatNumber(post.replyCount || 0)} replies</span>
                    <span class="engagement-item">${formatNumber(post.repostCount || 0)} reposts</span>
                    <span class="engagement-item">${formatNumber(post.likeCount || 0)} likes</span>
                </div>
            `;

            div.innerHTML = html;
            
            div.addEventListener('click', () => {
                const postUrl = `https://bsky.app/profile/${author.handle}/post/${post.uri.split('/').pop()}`;
                window.open(postUrl, '_blank');
            });

            return div;
        }

        function applyFacets(text, facets) {
            const sorted = facets.sort((a, b) => a.index.byteStart - b.index.byteStart);
            
            let result = '';
            let lastIndex = 0;
            
            sorted.forEach(facet => {
                const start = facet.index.byteStart;
                const end = facet.index.byteEnd;
                
                result += escapeHtml(text.substring(lastIndex, start));
                
                const facetText = text.substring(start, end);
                const feature = facet.features[0];
                
                if (feature.$type === 'app.bsky.richtext.facet#link') {
                    result += `<a href="${escapeHtml(feature.uri)}" target="_blank" onclick="event.stopPropagation()">${escapeHtml(facetText)}</a>`;
                } else if (feature.$type === 'app.bsky.richtext.facet#mention') {
                    result += `<a href="https://bsky.app/profile/${escapeHtml(feature.did)}" target="_blank" onclick="event.stopPropagation()">${escapeHtml(facetText)}</a>`;
                } else {
                    result += escapeHtml(facetText);
                }
                
                lastIndex = end;
            });
            
            result += escapeHtml(text.substring(lastIndex));
            
            return result;
        }

        async function loadMore() {
            if (isLoading || !currentCursor) return;
            
            setLoading(true);
            
            try {
                if (currentMode === 'posts') {
                    await loadPosts(true);
                } else {
                    await loadLikes(true);
                }
            } finally {
                setLoading(false);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd';
            if (seconds < 2592000) return Math.floor(seconds / 604800) + 'w';
            if (seconds < 31536000) return Math.floor(seconds / 2592000) + 'mo';
            return Math.floor(seconds / 31536000) + 'y';
        }
    </script>
</body>
</html>